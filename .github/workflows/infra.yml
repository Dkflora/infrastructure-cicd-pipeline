name: Terraform PR / Merge Workflow

on:
  pull_request:
    branches: [main]
    paths:
      - "**/*.tf"
      - "tf/**"
  push:
    branches: [main]
    paths:
      - "**/*.tf"
      - "tf/**"

permissions:
  contents: read
  pull-requests: write
  id-token: write   # Required for OIDC authentication
  actions: write

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # ----------------------
    # AWS OIDC AUTH (NO KEYS)
    # ----------------------
    - name: Configure AWS credentials (OIDC)
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: us-east-1

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0

    - name: Terraform fmt check
      run: terraform fmt -recursive -check

    - name: Terraform init
      run: terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=uat/terraform.tfstate" \
            -backend-config="region=us-east-1"

    - name: Terraform validate
      run: terraform validate

    # ----------------------
    # TFLINT
    # ----------------------
    - name: Install TFLint
      run: |
        curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash

    - name: TFLint run
      run: tflint --init && tflint

    # ----------------------
    # TRIVY IaC Security Scan
    # ----------------------
    - name: Run Trivy IaC Scan
      uses: aquasecurity/trivy-action@0.20.0
      with:
        scan-type: 'config'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        ignore-unfixed: true
        severity: 'CRITICAL,HIGH,MEDIUM'

    - name: Upload Trivy SARIF
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy-results.sarif

    # ----------------------
    # CHECKOV - IaC Security Scan
    # ----------------------
    - name: Run Checkov
      uses: bridgecrewio/checkov-action@v12
      with:
        directory: .
        framework: terraform
        output_format: sarif
        output_file_path: checkov-results.sarif
        soft_fail: true

    - name: Upload Checkov SARIF
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: checkov-results.sarif

    # ----------------------
    # TERRAFORM PLAN
    # ----------------------
    - name: Terraform plan
      run: terraform plan -out=plan.out

    - name: Upload plan artifact
      uses: actions/upload-artifact@v4
      with:
        name: tf-plan
        path: plan.out
        retention-days: 1



  # ====================================================================
  # APPLY JOB â€” ONLY RUNS AFTER MERGE INTO MAIN
  # ====================================================================
  apply:
    needs: check
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials (OIDC)
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: us-east-1

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0

    - name: Terraform init
      run: terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=uat/terraform.tfstate" \
            -backend-config="region=us-east-1"

    - name: Download plan artifact
      uses: actions/download-artifact@v4
      with:
        name: tf-plan
        path: .

    - name: Terraform apply
      run: terraform apply -auto-approve plan.out


